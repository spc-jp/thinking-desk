<!DOCTYPE html>
<html lang="ja" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thinking Desk</title>
    
    <!-- Tailwind CSS with Config -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        cream: {
                            50: '#fdfbf7',
                            100: '#f7f3e8',
                            200: '#efe5cd',
                            900: '#3d3828',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Google Fonts (Noto Sans JP) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark ::-webkit-scrollbar-thumb { background-color: #475569; }

        /* Paper card effect */
        .paper-card {
            transition: transform 0.2s ease, background-color 0.3s, border-color 0.3s;
        }
        
        /* Theme specific styles override */
        html.cream body { background-color: #f7f3e8; color: #4b4638; }
        html.cream .paper-card { background-color: #fdfbf7; border-color: #eaddc5; }
        html.cream header { background-color: #fdfbf7; border-bottom-color: #eaddc5; }
        html.cream .bg-gray-50 { background-color: #f4f0e2; }
        
        /* Modal & Dropdown Animations */
        .fade-enter { opacity: 0; transform: scale(0.95); }
        .fade-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }
        .fade-exit { opacity: 1; transform: scale(1); }
        .fade-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 0.2s, transform 0.2s; }

        /* Toast Animation */
        @keyframes slideInUp { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .toast-show { animation: slideInUp 0.3s forwards; }
        .toast-hide { animation: fadeOut 0.3s forwards; }

        /* Date Input Styling Override */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
            filter: invert(0.5);
        }
        .dark input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-gray-100 text-gray-700 dark:bg-slate-900 dark:text-slate-300">

    <!-- Header -->
    <header class="bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 px-4 sm:px-6 py-2 flex justify-between items-start sm:items-center shrink-0 z-20 relative gap-4">
        <div class="flex items-center gap-2 text-gray-700 dark:text-slate-200 py-2">
            <i data-lucide="pen-tool" class="w-5 h-5"></i>
            <h1 class="font-bold text-lg tracking-wide hidden sm:block">Thinking Desk</h1>
        </div>
        
        <!-- Project Info Inputs -->
        <div class="flex-1 max-w-2xl mx-auto flex flex-col gap-1 w-full">
            <!-- Row 1: Date & Context -->
            <div class="flex gap-2 sm:gap-4">
                <div class="relative shrink-0 w-32 sm:w-40">
                    <input type="date" id="dateInput" 
                        class="w-full bg-transparent border-b border-gray-200 dark:border-slate-600 focus:border-blue-500 outline-none py-1 text-xs sm:text-sm text-gray-500 dark:text-slate-400 font-mono">
                </div>
                <div class="flex-1">
                    <input type="text" id="contextInput" placeholder="誰と・どこで（例：A社 佐藤様と）" 
                        class="w-full bg-transparent border-b border-gray-200 dark:border-slate-600 focus:border-blue-500 outline-none py-1 text-xs sm:text-sm text-gray-600 dark:text-slate-300 placeholder-gray-300 dark:placeholder-slate-600">
                </div>
            </div>
            <!-- Row 2: Title (What) -->
            <div>
                <input type="text" id="projectTitle" placeholder="何を（案件名・テーマ）" 
                    class="w-full font-bold bg-transparent border-b-2 border-transparent focus:border-blue-500 outline-none py-1 text-sm sm:text-base text-gray-800 dark:text-slate-100 placeholder-gray-400 transition-colors">
            </div>
        </div>

        <!-- Right Toolbar -->
        <div class="flex items-center gap-2 sm:gap-3 py-2">
            <!-- History Button -->
            <button onclick="toggleModal('historyModal'); renderHistoryList();" class="p-2 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-slate-700" title="履歴（コピー時に自動保存）">
                <i data-lucide="history" class="w-5 h-5"></i>
            </button>
            
            <button onclick="toggleModal('helpModal')" class="p-2 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-slate-700" title="使い方">
                <i data-lucide="circle-help" class="w-5 h-5"></i>
            </button>
            <div class="relative">
                <button onclick="toggleDropdown('settingsDropdown')" class="p-2 text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-slate-700" title="設定">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
                
                <!-- Settings Dropdown -->
                <div id="settingsDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-gray-100 dark:border-slate-600 p-4 z-50 origin-top-right">
                    <div class="space-y-4">
                        <!-- Theme Selector -->
                        <div>
                            <p class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-wider">画面配色</p>
                            <div class="flex gap-2">
                                <button onclick="setTheme('light')" class="flex-1 h-8 rounded border border-gray-200 bg-gray-50 hover:border-blue-500 transition-colors" title="標準"></button>
                                <button onclick="setTheme('dark')" class="flex-1 h-8 rounded border border-slate-600 bg-slate-800 hover:border-blue-500 transition-colors" title="集中（ダーク）"></button>
                                <button onclick="setTheme('cream')" class="flex-1 h-8 rounded border border-[#eaddc5] bg-[#f7f3e8] hover:border-blue-500 transition-colors" title="紙（クリーム）"></button>
                            </div>
                        </div>
                        <hr class="border-gray-100 dark:border-slate-700">
                        <!-- Actions -->
                        <div class="space-y-2">
                            <button onclick="initLoadDemo()" class="w-full text-left px-3 py-2 text-sm text-gray-600 dark:text-slate-300 hover:bg-gray-50 dark:hover:bg-slate-700 rounded flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-4 h-4 text-yellow-500"></i>
                                デモデータを入力
                            </button>
                            <button onclick="initClearAll()" class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded flex items-center gap-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                すべてクリア
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Workspace: 3 Columns -->
    <main class="flex-1 overflow-y-auto sm:overflow-hidden p-2 sm:p-6 pb-32 sm:pb-6 grid grid-cols-1 md:grid-cols-10 gap-4 md:gap-6 max-w-[1600px] mx-auto w-full">
        
        <!-- Column 1: 今日の材料 (30%) -->
        <section class="md:col-span-3 paper-card bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-transparent dark:border-slate-700 flex flex-col h-auto md:h-full relative overflow-hidden group">
            <div class="bg-gray-50 dark:bg-slate-700/50 px-4 py-3 border-b border-gray-100 dark:border-slate-700 flex items-center justify-between">
                <h2 class="font-bold text-gray-700 dark:text-slate-200 flex items-center gap-2">
                    <span class="bg-gray-200 dark:bg-slate-600 text-gray-600 dark:text-slate-300 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                    今日の材料
                </h2>
                <i data-lucide="archive" class="w-4 h-4 text-gray-400"></i>
            </div>
            <div class="p-4 flex-1 overflow-y-auto flex flex-col gap-4">
                <div class="text-xs text-gray-400 mb-1">考える前に、とにかく全部放り込む</div>
                <textarea id="materialText" class="w-full flex-1 min-h-[150px] p-3 border border-gray-200 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-200 rounded resize-none focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-900 outline-none text-sm leading-relaxed" placeholder="・あのお客様の発言&#13;&#10;・現場で見た光景&#13;&#10;・気になったニュース..."></textarea>
                
                <div class="space-y-2">
                    <p class="text-xs font-bold text-gray-400 tracking-wider">感覚知・フラグ</p>
                    <div class="grid grid-cols-2 gap-2" id="checkboxContainer">
                        <!-- Checkboxes generated by JS or static -->
                        <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700/50 p-1 rounded transition">
                            <input type="checkbox" class="material-check w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" value="気になった数字">
                            <span class="text-sm text-gray-600 dark:text-slate-400">気になった数字</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700/50 p-1 rounded transition">
                            <input type="checkbox" class="material-check w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" value="社長の一言">
                            <span class="text-sm text-gray-600 dark:text-slate-400">社長の一言</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700/50 p-1 rounded transition">
                            <input type="checkbox" class="material-check w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" value="違和感">
                            <span class="text-sm text-gray-600 dark:text-slate-400">違和感</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700/50 p-1 rounded transition">
                            <input type="checkbox" class="material-check w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" value="宿題">
                            <span class="text-sm text-gray-600 dark:text-slate-400">宿題</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700/50 p-1 rounded transition">
                            <input type="checkbox" class="material-check w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" value="次回までの約束">
                            <span class="text-sm text-gray-600 dark:text-slate-400">次回までの約束</span>
                        </label>
                    </div>
                </div>

                <div class="pt-2 border-t border-dashed border-gray-200 dark:border-slate-700 space-y-2">
                    <p class="text-xs font-bold text-gray-400 tracking-wider">参照ファイル</p>
                    <div class="flex gap-3">
                        <label class="flex items-center gap-1 cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700/50 px-2 py-1 rounded border border-gray-100 dark:border-slate-600">
                            <input type="checkbox" class="file-check w-3 h-3 text-blue-600 rounded border-gray-300" value="資料あり">
                            <span class="text-xs text-gray-600 dark:text-slate-400">資料あり</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700/50 px-2 py-1 rounded border border-gray-100 dark:border-slate-600">
                            <input type="checkbox" class="file-check w-3 h-3 text-blue-600 rounded border-gray-300" value="Excelあり">
                            <span class="text-xs text-gray-600 dark:text-slate-400">Excelあり</span>
                        </label>
                        <label class="flex items-center gap-1 cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700/50 px-2 py-1 rounded border border-gray-100 dark:border-slate-600">
                            <input type="checkbox" class="file-check w-3 h-3 text-blue-600 rounded border-gray-300" value="PDFあり">
                            <span class="text-xs text-gray-600 dark:text-slate-400">PDFあり</span>
                        </label>
                    </div>
                </div>
            </div>
        </section>

        <!-- Column 2: 整理メモ (40%) -->
        <section class="md:col-span-4 paper-card bg-white dark:bg-slate-800 rounded-lg shadow-sm ring-1 ring-blue-50 dark:ring-slate-700 flex flex-col h-auto md:h-full mt-4 md:mt-0">
            <div class="bg-blue-50/50 dark:bg-slate-700/50 px-4 py-3 border-b border-blue-100 dark:border-slate-700 flex items-center justify-between">
                <h2 class="font-bold text-blue-800 dark:text-blue-400 flex items-center gap-2">
                    <span class="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                    整理メモ
                </h2>
                <i data-lucide="layout-list" class="w-4 h-4 text-blue-300 dark:text-slate-500"></i>
            </div>
            <div class="p-4 flex-1 overflow-y-auto space-y-6">
                <div class="text-xs text-gray-400 mb-1">左の材料をやさしく整理する（短文推奨）</div>

                <div class="space-y-1 group">
                    <label class="text-xs font-bold text-blue-800 dark:text-blue-400 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="alert-circle" class="w-3 h-3"></i> 課題
                    </label>
                    <textarea id="issueText" rows="3" class="w-full bg-transparent border-b border-gray-200 dark:border-slate-600 focus:border-blue-500 outline-none py-2 text-sm text-gray-700 dark:text-slate-200 resize-none transition-colors placeholder-gray-300 dark:placeholder-slate-600" placeholder="何が一番の問題か？"></textarea>
                </div>

                <div class="space-y-1 group">
                    <label class="text-xs font-bold text-blue-800 dark:text-blue-400 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="scale" class="w-3 h-3"></i> 論点
                    </label>
                    <textarea id="pointText" rows="3" class="w-full bg-transparent border-b border-gray-200 dark:border-slate-600 focus:border-blue-500 outline-none py-2 text-sm text-gray-700 dark:text-slate-200 resize-none transition-colors placeholder-gray-300 dark:placeholder-slate-600" placeholder="何を議論すべきか？（Yes/Noで答えられる問い）"></textarea>
                </div>

                <div class="space-y-1 group">
                    <label class="text-xs font-bold text-blue-800 dark:text-blue-400 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="lightbulb" class="w-3 h-3"></i> 仮説
                    </label>
                    <textarea id="hypothesisText" rows="4" class="w-full bg-transparent border-b border-gray-200 dark:border-slate-600 focus:border-blue-500 outline-none py-2 text-sm text-gray-700 dark:text-slate-200 resize-none transition-colors placeholder-gray-300 dark:placeholder-slate-600" placeholder="現時点での答えは何か？"></textarea>
                </div>
            </div>
        </section>

        <!-- Column 3: 次アクション (30%) -->
        <section class="md:col-span-3 paper-card bg-white dark:bg-slate-800 rounded-lg shadow-sm border-l-4 border-l-transparent md:border-l-0 flex flex-col h-auto md:h-full mt-4 md:mt-0">
            <div class="bg-gray-50 dark:bg-slate-700/50 px-4 py-3 border-b border-gray-100 dark:border-slate-700 flex items-center justify-between">
                <h2 class="font-bold text-gray-700 dark:text-slate-200 flex items-center gap-2">
                    <span class="bg-gray-800 dark:bg-slate-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span>
                    次アクション
                </h2>
                <i data-lucide="play-circle" class="w-4 h-4 text-gray-400"></i>
            </div>
            <div class="p-4 flex-1 overflow-y-auto flex flex-col">
                <div class="text-xs text-gray-400 mb-4">考えた結果を行動に変える（最大3つ）</div>
                <div class="space-y-4 flex-1 pb-24 md:pb-0">
                    <div class="flex items-start gap-3">
                        <span class="text-lg font-bold text-gray-300 dark:text-slate-600 font-mono mt-1">01</span>
                        <input type="text" id="action1" class="w-full bg-transparent border-b border-gray-200 dark:border-slate-600 focus:border-gray-800 dark:focus:border-slate-400 outline-none py-2 text-sm text-gray-800 dark:text-slate-200 placeholder-gray-300 dark:placeholder-slate-600 transition-colors" placeholder="次にやること">
                    </div>
                    <div class="flex items-start gap-3">
                        <span class="text-lg font-bold text-gray-300 dark:text-slate-600 font-mono mt-1">02</span>
                        <input type="text" id="action2" class="w-full bg-transparent border-b border-gray-200 dark:border-slate-600 focus:border-gray-800 dark:focus:border-slate-400 outline-none py-2 text-sm text-gray-800 dark:text-slate-200 placeholder-gray-300 dark:placeholder-slate-600 transition-colors" placeholder="次にやること">
                    </div>
                    <div class="flex items-start gap-3">
                        <span class="text-lg font-bold text-gray-300 dark:text-slate-600 font-mono mt-1">03</span>
                        <input type="text" id="action3" class="w-full bg-transparent border-b border-gray-200 dark:border-slate-600 focus:border-gray-800 dark:focus:border-slate-400 outline-none py-2 text-sm text-gray-800 dark:text-slate-200 placeholder-gray-300 dark:placeholder-slate-600 transition-colors" placeholder="次にやること">
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-gray-100 via-gray-100 to-transparent dark:from-slate-900 dark:via-slate-900 md:bg-none md:bottom-8 md:right-8 md:left-auto md:p-0 z-40 flex flex-row md:flex-col gap-3 justify-center md:items-end pointer-events-none">
        <!-- AI Prompt Copy Button -->
        <button onclick="copyForAI()" class="pointer-events-auto bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-700 dark:hover:bg-indigo-600 text-white shadow-lg rounded-full px-4 py-3 md:px-6 md:py-3 flex items-center gap-2 transition-all transform hover:scale-105 active:scale-95 group whitespace-nowrap shadow-indigo-900/20" title="NotebookLM/ChatGPT用プロンプト付きコピー">
            <i data-lucide="bot" class="w-5 h-5 text-indigo-100 group-hover:text-white transition-colors"></i>
            <span class="font-bold text-sm tracking-wide">AI指示書</span>
        </button>

        <!-- Normal Copy Button -->
        <button onclick="copyToClipboard()" class="pointer-events-auto bg-gray-800 dark:bg-slate-700 hover:bg-gray-700 dark:hover:bg-slate-600 text-white shadow-lg rounded-full px-6 py-3 md:px-8 md:py-4 flex items-center gap-3 transition-all transform hover:scale-105 active:scale-95 group whitespace-nowrap shadow-gray-900/20">
            <i data-lucide="clipboard-copy" class="w-5 h-5 text-gray-300 group-hover:text-white transition-colors"></i>
            <span class="font-bold tracking-wide">議事メモ</span>
        </button>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 text-sm py-2 px-6 rounded-full shadow-xl opacity-0 pointer-events-none z-50 flex items-center gap-2">
        <i data-lucide="check-circle" class="w-4 h-4"></i>
        <span>コピーしました</span>
    </div>

    <!-- Generic Confirm Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4 transition-opacity duration-200" onclick="if(event.target === this) closeConfirm()">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-95 opacity-0 duration-200" id="confirmModalContent">
            <div class="p-6">
                <h3 class="text-lg font-bold text-gray-800 dark:text-slate-100 mb-2" id="confirmTitle">確認</h3>
                <p class="text-sm text-gray-600 dark:text-slate-300" id="confirmMessage">実行しますか？</p>
            </div>
            <div class="bg-gray-50 dark:bg-slate-700/50 px-6 py-3 flex justify-end gap-3">
                <button onclick="closeConfirm()" class="px-4 py-2 text-sm text-gray-600 dark:text-slate-300 hover:bg-gray-100 dark:hover:bg-slate-600 rounded transition-colors">キャンセル</button>
                <button id="confirmOkBtn" class="px-4 py-2 text-sm text-white rounded transition-colors font-medium">実行する</button>
            </div>
        </div>
    </div>

    <!-- History Modal (New) -->
    <div id="historyModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-200" onclick="if(event.target === this) toggleModal('historyModal')">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-95 opacity-0 duration-200 flex flex-col max-h-[80vh]" id="historyModalContent">
            <div class="p-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold text-gray-800 dark:text-slate-100 flex items-center gap-2">
                    <i data-lucide="history" class="w-5 h-5 text-gray-400"></i>
                    コピー履歴
                </h3>
                <button onclick="toggleModal('historyModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-300">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-0" id="historyListContainer">
                <!-- History Items injected here -->
                <div class="p-8 text-center text-gray-400 text-sm">履歴はありません</div>
            </div>
            
            <div class="bg-gray-50 dark:bg-slate-700/50 px-4 py-3 text-center shrink-0">
                <p class="text-xs text-gray-400 dark:text-slate-500">※ コピー時に自動で保存されます（最大10件）</p>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity duration-200" onclick="if(event.target === this) toggleModal('helpModal')">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-2xl w-full max-w-lg overflow-hidden transform transition-all scale-95 opacity-0 duration-200" id="helpModalContent">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-slate-100">Thinking Desk の使い方</h3>
                    <button onclick="toggleModal('helpModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-slate-300">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="space-y-5 text-sm text-gray-600 dark:text-slate-300 leading-relaxed">
                    <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg border border-blue-100 dark:border-blue-800">
                        <p class="font-bold text-blue-800 dark:text-blue-300 mb-1">コンセプト：思考の「初速」を上げる</p>
                        <p>ここは分析ツールではありません。ExcelやPowerPointを開く前に、頭の中にあるモヤモヤを吐き出し、整理し、次のアクションへと繋げるための「考える机」です。</p>
                    </div>

                    <div class="space-y-4">
                        <div class="flex gap-3">
                            <span class="bg-gray-200 dark:bg-slate-600 text-gray-700 dark:text-slate-200 w-6 h-6 rounded-full flex shrink-0 items-center justify-center text-xs font-bold">1</span>
                            <div>
                                <strong class="text-gray-800 dark:text-slate-200">材料を広げる（左）</strong>
                                <p class="text-xs text-gray-500 dark:text-slate-400 mt-1">分類や整理は不要です。気になった事実、違和感、発言などを無秩序に書き出してください。</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <span class="bg-blue-600 text-white w-6 h-6 rounded-full flex shrink-0 items-center justify-center text-xs font-bold">2</span>
                            <div>
                                <strong class="text-gray-800 dark:text-slate-200">要点を絞る（中）</strong>
                                <p class="text-xs text-gray-500 dark:text-slate-400 mt-1">「課題」「論点」「仮説」の枠を使って、情報を構造化します。箇条書きや短文推奨です。</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <span class="bg-gray-800 dark:bg-slate-500 text-white w-6 h-6 rounded-full flex shrink-0 items-center justify-center text-xs font-bold">3</span>
                            <div>
                                <strong class="text-gray-800 dark:text-slate-200">動き出す（右）</strong>
                                <p class="text-xs text-gray-500 dark:text-slate-400 mt-1">思考を行動に変えます。ネクストアクションを最大3つに絞り込み、実行可能性を高めます。</p>
                            </div>
                        </div>
                        
                        <hr class="border-gray-100 dark:border-slate-700 my-1">

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="flex gap-2">
                                <span class="bg-gray-700 text-white w-6 h-6 rounded-full flex shrink-0 items-center justify-center text-xs font-bold"><i data-lucide="clipboard-copy" class="w-3 h-3"></i></span>
                                <div>
                                    <strong class="text-gray-800 dark:text-slate-200 text-xs">議事メモとして</strong>
                                    <p class="text-[10px] text-gray-500 dark:text-slate-400 mt-1">整形されたテキストをコピー。チャットや日報にそのまま貼れます。</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <span class="bg-indigo-600 text-white w-6 h-6 rounded-full flex shrink-0 items-center justify-center text-xs font-bold"><i data-lucide="bot" class="w-3 h-3"></i></span>
                                <div>
                                    <strong class="text-gray-800 dark:text-slate-200 text-xs">AIへの指示書として</strong>
                                    <p class="text-[10px] text-gray-500 dark:text-slate-400 mt-1">プロンプト付きでコピー。NotebookLM等で資料構成案を一瞬で作れます。</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded border border-yellow-100 dark:border-yellow-800/30 flex gap-2 items-center">
                             <i data-lucide="history" class="w-4 h-4 text-yellow-600 dark:text-yellow-500 shrink-0"></i>
                             <p class="text-xs text-yellow-800 dark:text-yellow-400">コピー時に履歴が自動保存されます。上の時計アイコンから復元可能です。</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-slate-700 px-6 py-4 text-center">
                <button onclick="toggleModal('helpModal')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-bold text-sm transition-colors">
                    理解しました
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // Initialize Date Input to Today if empty
        const dateInput = document.getElementById('dateInput');
        if (!dateInput.value) {
            dateInput.value = new Date().toISOString().split('T')[0];
        }

        // Theme Management
        function setTheme(themeName) {
            const html = document.documentElement;
            html.classList.remove('dark', 'cream');
            if (themeName === 'dark') html.classList.add('dark');
            else if (themeName === 'cream') html.classList.add('cream');
            localStorage.setItem('thinking_desk_theme', themeName);
            toggleDropdown('settingsDropdown', false);
        }

        const savedTheme = localStorage.getItem('thinking_desk_theme');
        if (savedTheme) setTheme(savedTheme);

        // UI Interactions
        function toggleDropdown(id, forceState) {
            const el = document.getElementById(id);
            const isHidden = el.classList.contains('hidden');
            const shouldShow = forceState !== undefined ? forceState : isHidden;
            if (shouldShow) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('settingsDropdown');
            const button = e.target.closest('button[onclick*="settingsDropdown"]');
            if (!button && !dropdown.contains(e.target) && !dropdown.classList.contains('hidden')) {
                dropdown.classList.add('hidden');
            }
        });

        function toggleModal(id) {
            const modal = document.getElementById(id);
            const content = modal.querySelector('div[id$="Content"]');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }, 10);
            } else {
                content.classList.remove('scale-100', 'opacity-100');
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => { modal.classList.add('hidden'); }, 200);
            }
        }

        // CONFIRM MODAL LOGIC
        let pendingAction = null;

        function showConfirm(title, msg, actionClass, actionFn) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = msg;
            
            const okBtn = document.getElementById('confirmOkBtn');
            okBtn.className = "px-4 py-2 text-sm text-white rounded transition-colors font-medium " + actionClass;
            
            pendingAction = actionFn;
            
            const modal = document.getElementById('confirmModal');
            const content = document.getElementById('confirmModalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeConfirm() {
            const modal = document.getElementById('confirmModal');
            const content = document.getElementById('confirmModalContent');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                pendingAction = null;
            }, 200);
        }

        document.getElementById('confirmOkBtn').addEventListener('click', () => {
            if (pendingAction) pendingAction();
            closeConfirm();
        });


        // Feature: Demo Data with Modal
        function initLoadDemo() {
            toggleDropdown('settingsDropdown', false);
            
            showConfirm(
                "デモデータの読み込み",
                "現在の入力内容は上書きされます。デモデータを読み込みますか？",
                "bg-blue-600 hover:bg-blue-700",
                runLoadDemo
            );
        }

        function runLoadDemo() {
            document.getElementById('dateInput').value = "2024-05-20";
            document.getElementById('contextInput').value = "A社 佐藤様と（本社にて）";
            document.getElementById('projectTitle').value = "製造業DXプロジェクト定例";

            document.getElementById('materialText').value = "・現場からの反発あり。「なぜ今のやり方を変えるのか？」という声。\n・部長は乗り気だが、現場リーダーのAさんが渋い顔をしている。\n・システム導入ありきで話が進んでいるのが原因かもしれない。";
            
            const checksToSet = ["違和感", "宿題", "資料あり"];
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = checksToSet.includes(cb.value);
            });

            document.getElementById('issueText').value = "現場メリットが伝わっておらず、トップダウンの押し付けに見えている。";
            document.getElementById('pointText').value = "現場の負担軽減効果をどう可視化して伝えるか？";
            document.getElementById('hypothesisText').value = "既存業務の工数削減データを先に見せれば、Aさんの納得感が変わるはず。";

            document.getElementById('action1').value = "Aさんと個別にランチミーティングを設定";
            document.getElementById('action2').value = "他社事例の工数削減数字をまとめる";
            document.getElementById('action3').value = "来週の定例のアジェンダを修正する";

            saveState();
        }

        // Feature: Clear Data with Modal
        function initClearAll() {
            toggleDropdown('settingsDropdown', false);
            showConfirm(
                "すべてクリア",
                "すべての入力内容を消去します。よろしいですか？",
                "bg-red-600 hover:bg-red-700",
                runClearAll
            );
        }

        function runClearAll() {
            document.querySelectorAll('input[type="text"], textarea').forEach(el => el.value = '');
            document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
            // Reset Date to Today
            document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
            saveState();
        }

        // Feature: Copy & Toast (Enhanced)
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            
            // Set base classes and icon settings
            let baseClasses = "fixed bottom-24 left-1/2 transform -translate-x-1/2 text-sm py-2 px-6 rounded-full shadow-xl opacity-0 pointer-events-none z-50 flex items-center gap-2 transition-all duration-300";
            let themeClasses = "";
            let iconName = "";
            let iconColor = "";

            if (isError) {
                themeClasses = "bg-red-900 text-white";
                iconName = "alert-circle";
                iconColor = "text-white";
            } else {
                themeClasses = "bg-gray-900 dark:bg-slate-800 border dark:border-slate-600 text-white";
                iconName = "check-circle";
                iconColor = "text-green-400";
            }

            toast.className = `${baseClasses} ${themeClasses}`;
            
            // Completely re-render inner HTML to ensure Lucide can process a fresh <i> tag
            toast.innerHTML = `
                <i data-lucide="${iconName}" class="w-4 h-4 ${iconColor}"></i>
                <span>${message}</span>
            `;
            
            // Re-initialize icons for the new content
            lucide.createIcons();

            // Handle animation
            requestAnimationFrame(() => {
                toast.classList.remove('toast-hide');
                toast.classList.add('toast-show');
                toast.style.opacity = '1';
            });

            setTimeout(() => {
                toast.classList.remove('toast-show');
                toast.classList.add('toast-hide');
                setTimeout(() => { toast.style.opacity = '0'; }, 300);
            }, 2000);
        }

        // Gather Data Logic (Shared)
        function getDeskData() {
            // Header Info
            const dateVal = document.getElementById('dateInput').value;
            const contextVal = document.getElementById('contextInput').value.trim();
            const titleVal = document.getElementById('projectTitle').value.trim() || '（件名なし）';

            const materialFree = document.getElementById('materialText').value.trim();
            const materialChecks = Array.from(document.querySelectorAll('.material-check:checked')).map(cb => `・[x] ${cb.value}`).join('\n');
            const fileChecks = Array.from(document.querySelectorAll('.file-check:checked')).map(cb => `・[x] ${cb.value}`).join('\n');

            let materialSection = "";
            if (materialFree) materialSection += materialFree + "\n";
            if (materialChecks) materialSection += materialChecks + "\n";
            if (fileChecks) materialSection += fileChecks + "\n";
            if (!materialSection) materialSection = "（なし）";

            const issue = document.getElementById('issueText').value.trim();
            const point = document.getElementById('pointText').value.trim();
            const hypothesis = document.getElementById('hypothesisText').value.trim();

            const act1 = document.getElementById('action1').value.trim();
            const act2 = document.getElementById('action2').value.trim();
            const act3 = document.getElementById('action3').value.trim();

            // Use formatted date for display
            const displayDate = dateVal.replace(/-/g, '/');
            
            return {
                title: `【日時】${displayDate}\n【相手】${contextVal || '（未記入）'}\n【件名】${titleVal}`,
                material: materialSection.trim(),
                organize: `・課題：${issue}\n・論点：${point}\n・仮説：${hypothesis}`,
                action: `① ${act1}\n② ${act2}\n③ ${act3}`,
                
                // Raw data for saving history state
                raw: {
                    date: dateVal,
                    context: contextVal,
                    title: titleVal,
                    materialFree,
                    materialChecks: Array.from(document.querySelectorAll('.material-check:checked')).map(cb => cb.value),
                    fileChecks: Array.from(document.querySelectorAll('.file-check:checked')).map(cb => cb.value),
                    issue, point, hypothesis, act1, act2, act3
                }
            };
        }

        // Normal Copy
        function copyToClipboard() {
            const data = getDeskData();
            const finalOutput = `${data.title}\n\n【今日の材料】\n${data.material}\n\n【整理メモ】\n${data.organize}\n\n【次アクション】\n${data.action}`;

            executeCopy(finalOutput);
            saveToHistory(data.raw); // Save to history on copy
        }

        // AI Prompt Copy
        function copyForAI() {
            const data = getDeskData();
            
            // AI Prompt
            const prompt = `あなたはトップクラスのビジネスコンサルタントです。
以下の現場メモを元に、次の2つのアウトプットを作成してください。
「資料あり」の項目がある場合は、別途アップロードされたPDF資料の内容も統合して分析してください。

【依頼内容】
1. **スライド構成案（PowerPoint骨子）**:
   - タイトルスライド
   - 現状の課題（「整理メモ」の「課題」を深掘り）
   - 提案の論点と仮説（「整理メモ」の「論点」「仮説」を元に）
   - 具体的なアクションプラン（「次アクション」を詳細化）
   - まとめ

2. **インフォグラフィックの構成案**:
   - このプロジェクトの全体像を1枚の絵で説明するための図解アイデア
   - 配置すべき要素と矢印の流れ

---
【入力された現場メモ】
${data.title}

[今日の材料（事実・観測）]
${data.material}

[整理メモ（思考の途中経過）]
${data.organize}

[決定した次アクション]
${data.action}
---`;

            executeCopy(prompt, "AI指示用プロンプトをコピー");
            saveToHistory(data.raw); // Save to history on copy
        }

        function executeCopy(text, successMsg = "コピーしました") {
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text)
                    .then(() => showToast(successMsg))
                    .catch(() => fallbackCopy(text, successMsg));
            } else {
                fallbackCopy(text, successMsg);
            }
        }

        function fallbackCopy(text, successMsg) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast(successMsg);
            } catch (err) {
                showToast("コピーに失敗しました", true);
            }
            document.body.removeChild(textArea);
        }

        // HISTORY MANAGEMENT
        function saveToHistory(rawData) {
            let history = JSON.parse(localStorage.getItem('thinking_desk_history') || '[]');
            
            // Create entry
            const entry = {
                id: Date.now(),
                timestamp: new Date().toLocaleString('ja-JP'),
                data: rawData
            };
            
            // Add to top
            history.unshift(entry);
            
            // Limit to 10
            if (history.length > 10) {
                history = history.slice(0, 10);
            }
            
            localStorage.setItem('thinking_desk_history', JSON.stringify(history));
        }

        function renderHistoryList() {
            const container = document.getElementById('historyListContainer');
            const history = JSON.parse(localStorage.getItem('thinking_desk_history') || '[]');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-400 text-sm">履歴はありません</div>';
                return;
            }
            
            container.innerHTML = '';
            
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = "p-4 border-b border-gray-100 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700 cursor-pointer transition-colors group";
                div.onclick = () => loadFromHistory(item.id);
                
                const title = item.data.title || '（件名なし）';
                const date = item.data.date || '';
                
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-xs font-mono text-gray-400 dark:text-slate-500">${item.timestamp} 保存</span>
                        <span class="text-xs text-blue-600 dark:text-blue-400 opacity-0 group-hover:opacity-100 font-bold transition-opacity">復元する</span>
                    </div>
                    <h4 class="font-bold text-gray-700 dark:text-slate-200 text-sm mb-1">${title}</h4>
                    <p class="text-xs text-gray-500 dark:text-slate-400 truncate">${item.data.context || ''} ${date}</p>
                `;
                container.appendChild(div);
            });
        }

        function loadFromHistory(id) {
            const history = JSON.parse(localStorage.getItem('thinking_desk_history') || '[]');
            const entry = history.find(h => h.id === id);
            
            if (!entry) return;
            
            if (!confirm('現在の入力内容を破棄して、この履歴を復元しますか？')) return;
            
            const d = entry.data;
            
            document.getElementById('dateInput').value = d.date;
            document.getElementById('contextInput').value = d.context;
            document.getElementById('projectTitle').value = d.title;
            
            document.getElementById('materialText').value = d.materialFree;
            
            // Reset and set checks
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            if (d.materialChecks) {
                d.materialChecks.forEach(val => {
                    const cb = document.querySelector(`.material-check[value="${val}"]`);
                    if (cb) cb.checked = true;
                });
            }
            if (d.fileChecks) {
                d.fileChecks.forEach(val => {
                    const cb = document.querySelector(`.file-check[value="${val}"]`);
                    if (cb) cb.checked = true;
                });
            }

            document.getElementById('issueText').value = d.issue;
            document.getElementById('pointText').value = d.point;
            document.getElementById('hypothesisText').value = d.hypothesis;

            document.getElementById('action1').value = d.act1;
            document.getElementById('action2').value = d.act2;
            document.getElementById('action3').value = d.act3;
            
            toggleModal('historyModal');
            saveState(); // Save as current draft
            showToast("復元しました");
        }

        const inputs = document.querySelectorAll('input, textarea');
        function saveState() {
            const state = {};
            inputs.forEach(input => {
                if(input.type === 'checkbox') state[input.value] = input.checked;
                else state[input.id] = input.value;
            });
            localStorage.setItem('thinking_desk_draft', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('thinking_desk_draft');
            if (saved) {
                const state = JSON.parse(saved);
                inputs.forEach(input => {
                    if(input.type === 'checkbox') {
                        if (state[input.value] !== undefined) input.checked = state[input.value];
                    } else if (state[input.id]) {
                        input.value = state[input.id];
                    }
                });
            }
        }

        loadState();
        inputs.forEach(input => input.addEventListener('input', saveState));
    </script>
</body>
</html>